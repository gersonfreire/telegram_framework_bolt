import logging
import sys
import platform
import os

logger = logging.getLogger(__name__)

def ping_host(self=None, ip_address='localhost', show_success=True, user_id=None)-> Bool:
    """
    Pings a given IP address and sends a message indicating whether the host is up or down.
    Args:
        self (optional): The instance of the class. Defaults to None.
        ip_address (str): The IP address of the host to ping. Defaults to 'localhost'.
        show_success (bool, optional): If True, sends a message when the host is up. Defaults to True.
        user_id (str, optional): The user ID to send the message to. If None, no message is sent. Defaults to None.        
    Returns:
        Bool: True if the host is up, False if the host is down.
    Raises:
        Exception: If an error occurs during the ping process, an error message is sent to the bot owner.    
    """
    
    try:
        logger.debug(f"Pinging {ip_address}...")

        param = "-n 1" if platform.system().lower() == "windows" else "-c 1"
        response = os.system(f"ping {param} {ip_address}") # Returns 0 if the host is up, 1 if the host is down
        
        logger.debug(f"Ping response for {ip_address}: {response}")

        # send message if an instance of bot was given
        if self:
            message = f"{ip_address} is up!" if response == 0 else f"{ip_address} is down!"
            logger.debug(message)
            self.send_message_by_api(user_id, message) if response != 0 or show_success else None
        
        return response == 0
            
    except Exception as e:
        exc_type, exc_obj, exc_tb = sys.exc_info()
        fname = os.path.split(exc_tb.tb_frame.f_code.co_filename)[1]
        logger.error(f"An error occurred while pinging {ip_address}: {e}, in {fname} at line {exc_tb.tb_lineno}")
        return False

if __name__ == "__main__":

    ip_address = sys.argv[1] if len(sys.argv) > 1 else 'localhost'
    show_success = sys.argv[2].lower() == 'true' if len(sys.argv) > 2 else True
    user_id = sys.argv[3] if len(sys.argv) > 3 else None

    ping_host(ip_address=ip_address, show_success=show_success, user_id=user_id)
    logger = logging.getLogger(__name__)
    logger.error(f"An error occurred while pinging {ip_address}: {e}")